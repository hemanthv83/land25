<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Land Registration</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        /* General Styles */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            text-align: center;
            background-color: #f4f4f4;
        }

        header {
            background-color: #2c3e50;
            color: white;
            padding: 15px 0;
            position: fixed;
            width: 100%;
            top: 0;
            left: 0;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            max-width: 1200px;
            margin: auto;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            display: flex;
            align-items: center;
        }

        .logo img {
            height: 40px;
            margin-right: 10px;
        }

        .nav-links {
            display: flex;
            list-style: none;
            padding: 0;
        }

        .nav-links li {
            margin-left: 20px;
        }

        .nav-links a {
            color: white;
            text-decoration: none;
            font-size: 1rem;
            transition: color 0.3s;
        }

        .nav-links a:hover {
            color: #f4f4f4;
        }

        .btn {
            display: inline-block;
            padding: 8px 15px;
            background: #f39c12;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            font-size: 1rem;
            transition: background 0.3s;
        }

        .btn:hover {
            background: #e67e22;
        }

        .form-section {
            background: white;
            padding: 20px;
            max-width: 500px;
            margin: 70px auto;
            border-radius: 10px;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
            text-align: left;
        }

        label {
            display: block;
            margin: 10px 0 5px;
        }

        input, select {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        canvas {
            border: 1px solid black;
            width: 100%;
            height: 150px;
            margin-top: 10px;
        }

        .hidden {
            display: none;
            color: green;
            margin-top: 10px;
        }

        /* Video styling */
        #videoContainer {
            margin: 15px 0;
        }

        #videoElement {
            width: 100%;
            height: 300px;
            background-color: #000;
            border-radius: 5px;
        }

        .video-controls {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }

        .video-timer {
            font-size: 14px;
            margin-top: 5px;
            color: #666;
        }

        .recording-indicator {
            display: none;
            color: red;
            font-weight: bold;
            margin-left: 10px;
        }
        
        /* Location info */
        .location-info {
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px;
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            font-size: 12px;
            text-align: left;
            border-bottom-left-radius: 5px;
            border-bottom-right-radius: 5px;
        }
        
        #videoWrapper {
            position: relative;
        }
        
        .location-status {
            margin-top: 5px;
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 12px;
        }
        
        .status-success {
            background-color: #27ae60;
            color: white;
        }
        
        .status-error {
            background-color: #e74c3c;
            color: white;
        }

        /* Sentiment Analysis Styling */
        .sentiment-container {
            margin-top: 15px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #f9f9f9;
        }

        .sentiment-title {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .emotion-bar {
            height: 20px;
            margin: 5px 0;
            border-radius: 3px;
            display: flex;
            align-items: center;
            overflow: hidden;
            background-color: #eee;
        }

        .emotion-fill {
            height: 100%;
            display: flex;
            align-items: center;
            padding-left: 5px;
            color: white;
            font-size: 12px;
            transition: width 0.3s ease;
        }

        .emotion-label {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
        }

        .sentiment-summary {
            margin-top: 10px;
            padding: 5px;
            border-radius: 3px;
            text-align: center;
        }

        .positive-summary {
            background-color: #d4edda;
            color: #155724;
        }

        .neutral-summary {
            background-color: #fff3cd;
            color: #856404;
        }

        .negative-summary {
            background-color: #f8d7da;
            color: #721c24;
        }

        #faceDetectionCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 300px;
            z-index: 10;
        }
        
        /* Aadhaar Recognition Styling */
        .aadhaar-container {
            margin-top: 20px;
            border: 1px solid #ccc;
            padding: 15px;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        
        .aadhaar-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #2c3e50;
            text-align: center;
        }
        
        .aadhaar-video-container {
            position: relative;
            margin-bottom: 15px;
        }
        
        #aadhaarVideo {
            width: 100%;
            height: 200px;
            background-color: #000;
            border-radius: 5px;
        }
        
        #aadhaarCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 200px;
            z-index: 15;
        }
        
        .capture-container {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        
        .capture-btn {
            flex-grow: 1;
            margin-right: 5px;
        }
        
        .reset-btn {
            flex-grow: 1;
            margin-left: 5px;
            background-color: #95a5a6;
        }
        
        .aadhaar-result {
            padding: 10px;
            border-radius: 5px;
            background-color: #f0f0f0;
            margin-top: 10px;
            font-size: 14px;
        }
        
        .aadhaar-number {
            font-size: 16px;
            font-weight: bold;
            color: #2c3e50;
            margin-top: 5px;
            letter-spacing: 1px;
        }
        
        .aadhaar-status {
            margin-top: 10px;
            padding: 5px;
            border-radius: 3px;
            text-align: center;
            font-weight: bold;
        }
        
        .status-verified {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status-pending {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .status-failed {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .aadhaar-instructions {
            font-size: 12px;
            color: #666;
            margin-bottom: 10px;
            text-align: center;
            font-style: italic;
        }
        
        .scan-guide {
            border: 2px dashed #3498db;
            position: absolute;
            top: 10%;
            left: 10%;
            width: 80%;
            height: 80%;
            z-index: 16;
            pointer-events: none;
        }
        
        .scan-guide-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 12px;
            pointer-events: none;
        }
        
        .processing-indicator {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 20;
        }
        
        .processing-indicator::after {
            content: "...";
            animation: dots 1.5s infinite;
        }
        
        @keyframes dots {
            0%, 20% { content: "."; }
            40% { content: ".."; }
            60%, 100% { content: "..."; }
        }
        
        .verification-step {
            display: flex;
            align-items: center;
            margin: 5px 0;
        }
        
        .step-icon {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: white;
        }
        
        .step-pending {
            background-color: #95a5a6;
        }
        
        .step-complete {
            background-color: #2ecc71;
        }
        
        .step-error {
            background-color: #e74c3c;
        }
    </style>
</head>
<body>
<header>
    <nav class="container">
        <div class="logo">
            <img src="/api/placeholder/40/40" alt="Logo"> Digital Land Registry
        </div>
        <ul class="nav-links">
            <li><a href="index.html">Home</a></li>
            <li><a href="#services">Services</a></li>
            <li><a href="#process">Process</a></li>
            <li><a href="#contact">Contact</a></li>
            <li><a href="dashboard.html">Dashboard</a></li>
            <li><a href="login.html" class="btn">Login/Register</a></li>
        </ul>
    </nav>
</header>

<section class="hero" id="home">
    <h1>Digital Land Registration Portal</h1>
    <p>Register your land online with our secure, efficient, and paperless process.</p>
    <a href="#registrationForm" class="btn" id="getStartedBtn">Get Started</a>
</section>

<section id="registrationForm" class="form-section">
    <h2>Land Registration Form</h2>
    <form id="landForm">
        <!-- Aadhaar Card Verification Section -->
        <div class="aadhaar-container">
            <div class="aadhaar-title">Aadhaar Card Verification</div>
            <div class="aadhaar-instructions">
                Please position your Aadhaar card within the frame. Hold it steady for OCR scanning.
            </div>
            
            <div class="aadhaar-video-container">
                <video id="aadhaarVideo" autoplay muted></video>
                <canvas id="aadhaarCanvas"></canvas>
                <div class="scan-guide">
                    <span class="scan-guide-text">Align Aadhaar card here</span>
                </div>
                <div id="processingIndicator" class="processing-indicator">Processing</div>
            </div>
            
            <div class="capture-container">
                <button type="button" id="captureAadhaarBtn" class="btn capture-btn">Capture Aadhaar</button>
                <button type="button" id="resetAadhaarBtn" class="btn reset-btn">Reset</button>
            </div>
            
            <div class="aadhaar-result">
                <div class="verification-step">
                    <span id="stepOCR" class="step-icon step-pending">1</span>
                    <span>OCR scanning</span>
                </div>
                <div class="verification-step">
                    <span id="stepValidation" class="step-icon step-pending">2</span>
                    <span>Validation</span>
                </div>
                <div class="verification-step">
                    <span id="stepVerification" class="step-icon step-pending">3</span>
                    <span>Verification</span>
                </div>
                
                <div>
                    <label for="aadhaarNumber">Aadhaar Number:</label>
                    <input type="text" id="aadhaarNumber" placeholder="XXXX XXXX XXXX" maxlength="14" readonly>
                </div>
                
                <div id="aadhaarStatus" class="aadhaar-status status-pending">
                    Awaiting Aadhaar verification
                </div>
            </div>
        </div>

        <div id="videoContainer">
            <label>Video Proof with Location Data:</label>
            <div id="videoWrapper">
                <video id="videoElement" autoplay muted></video>
                <canvas id="faceDetectionCanvas"></canvas>
                <div id="locationInfo" class="location-info">
                    <div>Date & Time: <span id="datetime">Waiting...</span></div>
                    <div>Location: <span id="gpsCoordinates">Waiting for GPS...</span></div>
                    <div>Address: <span id="gpsAddress">Resolving address...</span></div>
                </div>
            </div>
            <div id="locationStatus"></div>
            <div class="video-controls">
                <button type="button" id="startRecordBtn" class="btn">Record Video</button>
                <button type="button" id="stopRecordBtn" class="btn" disabled>Stop Recording</button>
                <span id="recordingIndicator" class="recording-indicator">● Recording</span>
            </div>
            <div class="video-timer" id="recordingTimer">00:00</div>

            <!-- Video Sentiment Analysis Container -->
            <div id="sentimentContainer" class="sentiment-container">
                <div class="sentiment-title">Video AI Sentiment Analysis</div>
                <div>
                    <div class="emotion-label">
                        <span>Happy</span>
                        <span id="happyValue">0%</span>
                    </div>
                    <div class="emotion-bar">
                        <div id="happyFill" class="emotion-fill" style="width: 0%; background-color: #28a745;"></div>
                    </div>
                </div>
                <div>
                    <div class="emotion-label">
                        <span>Neutral</span>
                        <span id="neutralValue">0%</span>
                    </div>
                    <div class="emotion-bar">
                        <div id="neutralFill" class="emotion-fill" style="width: 0%; background-color: #ffc107;"></div>
                    </div>
                </div>
                <div>
                    <div class="emotion-label">
                        <span>Sad</span>
                        <span id="sadValue">0%</span>
                    </div>
                    <div class="emotion-bar">
                        <div id="sadFill" class="emotion-fill" style="width: 0%; background-color: #dc3545;"></div>
                    </div>
                </div>
                <div>
                    <div class="emotion-label">
                        <span>Angry</span>
                        <span id="angryValue">0%</span>
                    </div>
                    <div class="emotion-bar">
                        <div id="angryFill" class="emotion-fill" style="width: 0%; background-color: #6f42c1;"></div>
                    </div>
                </div>
                <div id="sentimentSummary" class="sentiment-summary neutral-summary">
                    Overall: Waiting for recording...
                </div>
            </div>
        </div>
        <label for="userRole">Select Role:</label>
        <select id="userRole" required>
            <option value="seller">Seller</option>
            <option value="buyer">Buyer</option>
        </select>

        <label for="ownerName">Full Name:</label>
        <input type="text" id="ownerName" required>

        <label for="landLocation">Land Location:</label>
        <input type="text" id="landLocation" required>

        <label for="landSize">Land Size (in sq. meters):</label>
        <input type="number" id="landSize" required>

        <label for="feedback">Feedback (for text sentiment analysis):</label>
        <input type="text" id="feedback" required>

        <label>Draw Your Digital Signature:</label>
        <canvas id="signatureCanvas"></canvas>
        <button type="button" onclick="clearCanvas()" class="btn">Clear Signature</button>

        <button type="submit" id="submitBtn" class="btn" disabled>Submit</button>
        <div id="aadhaarVerificationRequired" class="status-error" style="margin-top: 10px; text-align: center;">
            Aadhaar verification required before submission
        </div>
    </form>
    <p id="confirmationMessage" class="hidden">Your land registration has been submitted successfully!</p>
</section>

<!-- Load Face API -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/face-api.js/0.22.2/face-api.min.js"></script>
<!-- Load Tesseract.js for OCR -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/2.1.5/tesseract.min.js"></script>

<script>
    const form = document.getElementById("landForm");
    const message = document.getElementById("confirmationMessage");
    const canvas = document.getElementById("signatureCanvas");
    const ctx = canvas.getContext("2d");
    const getStartedBtn = document.getElementById("getStartedBtn");
    const videoElement = document.getElementById("videoElement");
    const startRecordBtn = document.getElementById("startRecordBtn");
    const stopRecordBtn = document.getElementById("stopRecordBtn");
    const recordingIndicator = document.getElementById("recordingIndicator");
    const recordingTimer = document.getElementById("recordingTimer");
    const datetimeElement = document.getElementById("datetime");
    const gpsCoordinatesElement = document.getElementById("gpsCoordinates");
    const gpsAddressElement = document.getElementById("gpsAddress");
    const locationStatusElement = document.getElementById("locationStatus");
    const faceDetectionCanvas = document.getElementById("faceDetectionCanvas");
    const submitButton = document.getElementById("submitBtn");
    const aadhaarVerificationRequired = document.getElementById("aadhaarVerificationRequired");
    
    // Aadhaar related elements
    const aadhaarVideo = document.getElementById("aadhaarVideo");
    const aadhaarCanvas = document.getElementById("aadhaarCanvas");
    const captureAadhaarBtn = document.getElementById("captureAadhaarBtn");
    const resetAadhaarBtn = document.getElementById("resetAadhaarBtn");
    const aadhaarNumberInput = document.getElementById("aadhaarNumber");
    const aadhaarStatusElement = document.getElementById("aadhaarStatus");
    const processingIndicator = document.getElementById("processingIndicator");
    const stepOCR = document.getElementById("stepOCR");
    const stepValidation = document.getElementById("stepValidation");
    const stepVerification = document.getElementById("stepVerification");
    
    let isDrawing = false;
    let mediaRecorder;
    let recordedChunks = [];
    let stream;
    let timerInterval;
    let recordingTime = 0;
    let locationUpdateInterval;
    let currentPosition = null;
    let faceDetectionInterval;
    let isFaceAPILoaded = false;
    let emotionData = {
        happy: [],
        neutral: [],
        sad: [],
        angry: []
    };
    
    let aadhaarStream;
    let isAadhaarVerified = false;
    let capturedAadhaarImage = null;
    
    // Initialize canvas for signature
    canvas.width = 500;
    canvas.height = 150;
    ctx.lineWidth = 2;
    ctx.strokeStyle = "#000";
    
    canvas.addEventListener("mousedown", startDrawing);
    canvas.addEventListener("touchstart", startDrawing);
    
    canvas.addEventListener("mouseup", stopDrawing);
    canvas.addEventListener("touchend", stopDrawing);
    
    canvas.addEventListener("mousemove", draw);
    canvas.addEventListener("touchmove", draw);
    
    function startDrawing(event) {
        event.preventDefault();
        isDrawing = true;
        
        const x = event.type.includes('mouse') ? event.offsetX : event.touches[0].clientX - canvas.getBoundingClientRect().left;
        const y = event.type.includes('mouse') ? event.offsetY : event.touches[0].clientY - canvas.getBoundingClientRect().top;
        
        ctx.beginPath();
        ctx.moveTo(x, y);
    }
    
    function stopDrawing() {
        isDrawing = false;
    }
    
    function draw(event) {
        if (!isDrawing) return;
        
        event.preventDefault();
        const x = event.type.includes('mouse') ? event.offsetX : event.touches[0].clientX - canvas.getBoundingClientRect().left;
        const y = event.type.includes('mouse') ? event.offsetY : event.touches[0].clientY - canvas.getBoundingClientRect().top;
        
        ctx.lineTo(x, y);
        ctx.stroke();
    }

    function clearCanvas() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    // Initialize Face-API.js
    async function initFaceAPI() {
        try {
            await faceapi.nets.tinyFaceDetector.loadFromUri('https://cdnjs.cloudflare.com/ajax/libs/face-api.js/models/tiny_face_detector_model-weights_manifest.json');
            await faceapi.nets.faceExpressionNet.loadFromUri('https://cdnjs.cloudflare.com/ajax/libs/face-api.js/models/face_expression_model-weights_manifest.json');
            
            console.log("Face API models loaded");
            isFaceAPILoaded = true;
            
            // Set up canvas
            faceDetectionCanvas.width = videoElement.videoWidth;
            faceDetectionCanvas.height = videoElement.videoHeight;
            
        } catch (error) {
            console.error("Error loading Face API models:", error);
            alert("Failed to load facial recognition models. Sentiment analysis may not work.");
        }
    }
    
    // Start face detection
    function startFaceDetection() {
        if (!isFaceAPILoaded) {
            console.warn("Face API not loaded yet");
            return;
        }
        
        faceDetectionInterval = setInterval(async () => {
            if (videoElement.readyState === 4) {
                const canvasCtx = faceDetectionCanvas.getContext('2d');
                faceDetectionCanvas.width = videoElement.videoWidth;
                faceDetectionCanvas.height = videoElement.videoHeight;
                
                // Detect faces with expressions
                const detections = await faceapi.detectAllFaces(
                    videoElement, 
                    new faceapi.TinyFaceDetectorOptions()
                ).withFaceExpressions();
                
                if (detections.length > 0) {
                    // Clear canvas
                    canvasCtx.clearRect(0, 0, faceDetectionCanvas.width, faceDetectionCanvas.height);
                    
                    // Draw detections
                    detections.forEach(detection => {
                        // Draw face box
                        const box = detection.detection.box;
                        canvasCtx.strokeStyle = "#3498db";
                        canvasCtx.lineWidth = 2;
                        canvasCtx.strokeRect(box.x, box.y, box.width, box.height);
                        
                        // Record emotions if recording
                        if (mediaRecorder && mediaRecorder.state === "recording") {
                            const expressions = detection.expressions;
                            
                            // Simplify expressions into 4 categories
                            const happy = expressions.happy;
                            const sad = expressions.sad;
                            const angry = expressions.angry;
                            const neutral = expressions.neutral;
                            
                            emotionData.happy.push(happy);
                            emotionData.sad.push(sad);
                            emotionData.angry.push(angry);
                            emotionData.neutral.push(neutral);
                            
                            // Update sentiment UI
                            updateSentimentUI();
                        }
                    });
                }
            }
        }, 100);
    }
    
    // Stop face detection
    function stopFaceDetection() {
        if (faceDetectionInterval) {
            clearInterval(faceDetectionInterval);
        }
    }
    
    // Update sentiment UI based on collected emotion data
    function updateSentimentUI() {
        if (emotionData.happy.length === 0) return;
        
        // Calculate average for each emotion
        const avgHappy = emotionData.happy.reduce((sum, val) => sum + val, 0) / emotionData.happy.length;
        const avgSad = emotionData.sad.reduce((sum, val) => sum + val, 0) / emotionData.sad.length;
        const avgAngry = emotionData.angry.reduce((sum, val) => sum + val, 0) / emotionData.angry.length;
        const avgNeutral = emotionData.neutral.reduce((sum, val) => sum + val, 0) / emotionData.neutral.length;
        
        // Convert to percentages
        const happyPercent = Math.round(avgHappy * 100);
        const sadPercent = Math.round(avgSad * 100);
        const angryPercent = Math.round(avgAngry * 100);
        const neutralPercent = Math.round(avgNeutral * 100);
        
        // Update UI elements
        document.getElementById("happyValue").textContent = `${happyPercent}%`;
        document.getElementById("happyFill").style.width = `${happyPercent}%`;
        
        document.getElementById("sadValue").textContent = `${sadPercent}%`;
        document.getElementById("sadFill").style.width = `${sadPercent}%`;
        
        document.getElementById("angryValue").textContent = `${angryPercent}%`;
        document.getElementById("angryFill").style.width = `${angryPercent}%`;
        
        document.getElementById("neutralValue").textContent = `${neutralPercent}%`;
        document.getElementById("neutralFill").style.width = `${neutralPercent}%`;
        
        // Determine overall sentiment
        const summaryElement = document.getElementById("sentimentSummary");
        let dominantEmotion = "neutral";
        let highestValue = neutralPercent;
        
        if (happyPercent > highestValue) {
            dominantEmotion = "happy";
            highestValue = happyPercent;
        }
        if (sadPercent > highestValue) {
            dominantEmotion = "sad";
            highestValue = sadPercent;
        }
        if (angryPercent > highestValue) {
            dominantEmotion = "angry";
            highestValue = angryPercent;
        }
        
        // Set summary text and style
        summaryElement.className = "sentiment-summary";
        
        if (dominantEmotion === "happy") {
            summaryElement.textContent = "Overall: Positive";
            summaryElement.classList.add("positive-summary");
        } else if (dominantEmotion === "neutral") {
            summaryElement.textContent = "Overall: Neutral";
            summaryElement.classList.add("neutral-summary");
        } else {
            summaryElement.textContent = "Overall: Negative";
            summaryElement.classList.add("negative-summary");
        }
    }
    
    // Get final video sentiment
    function getFinalSentiment() {
        if (emotionData.happy.length === 0) {
            return "Neutral"; // Default if no data
        }
        
        const avgHappy = emotionData.happy.reduce((sum, val) => sum + val, 0) / emotionData.happy.length;
        const avgSad = emotionData.sad.reduce((sum, val) => sum + val, 0) / emotionData.sad.length;
        const avgAngry = emotionData.angry.reduce((sum, val) => sum + val, 0) / emotionData.angry.length;
        const avgNeutral = emotionData.neutral.reduce((sum, val) => sum + val, 0) / emotionData.neutral.length;
        
        // Simple logic for overall sentiment
        if (avgHappy > Math.max(avgSad, avgAngry, avgNeutral)) {
            return "Positive";
        } else if (avgSad > Math.max(avgHappy, avgAngry, avgNeutral) || 
                 avgAngry > Math.max(avgHappy, avgSad, avgNeutral)) {
            return "Negative";
        } else {
            return "Neutral";
        }
    }
    
    // Initialize video capture with location tracking
    async function initVideoCapture() {
        try {
            // Request camera permissions
            stream = await navigator.mediaDevices.getUserMedia({ 
                video: {
                    facingMode: "user",
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                }, 
                audio: true 
            });
            
            videoElement.srcObject = stream;
            console.log("Camera access granted");
            
            // Load face detection models
            await initFaceAPI();
            
            // Start location tracking
            startLocationTracking();
            
        } catch (error) {
            console.error("Error accessing camera:", error);
            alert("Camera access is required for video verification. Please allow camera access and reload the page.");
        }
    }
    
    // Initialize Aadhaar video capture
    async function initAadhaarCapture() {
        try {
            // Request camera permissions
            aadhaarStream = await navigator.mediaDevices.getUserMedia({ 
                video: {
                    facingMode: "environment",
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                }
            });
            
            aadhaarVideo.srcObject = aadhaarStream;
            console.log("Aadhaar camera access granted");
            
        } catch (error) {
            console.error("Error accessing camera for Aadhaar:", error);
            alert("Camera access is required for Aadhaar verification. Please allow camera access and reload the page.");
        }
    }
    
    // Capture Aadhaar image
    captureAadhaarBtn.addEventListener("click", async () => {
        const context = aadhaarCanvas.getContext("2d");
        aadhaarCanvas.width = aadhaarVideo.videoWidth;
        aadhaarCanvas.height = aadhaarVideo.videoHeight;
        
        context.drawImage(aadhaarVideo, 0, 0, aadhaarCanvas.width, aadhaarCanvas.height);
        capturedAadhaarImage = aadhaarCanvas.toDataURL("image/png");
        
        // Show processing indicator
        processingIndicator.style.display = "block";
        
        // Update OCR step status
        stepOCR.className = "step-icon step-complete";
        stepOCR.textContent = "✓";
        
        // Simulate OCR processing
        setTimeout(() => {
            processAadhaarOCR(aadhaarCanvas);
        }, 2000);
    });
    
    // Reset Aadhaar capture
    resetAadhaarBtn.addEventListener("click", () => {
        const context = aadhaarCanvas.getContext("2d");
        context.clearRect(0, 0, aadhaarCanvas.width, aadhaarCanvas.height);
        aadhaarNumberInput.value = "";
        capturedAadhaarImage = null;
        
        // Reset step indicators
        stepOCR.className = "step-icon step-pending";
        stepOCR.textContent = "1";
        stepValidation.className = "step-icon step-pending";
        stepValidation.textContent = "2";
        stepVerification.className = "step-icon step-pending";
        stepVerification.textContent = "3";
        
        // Reset status
        aadhaarStatusElement.className = "aadhaar-status status-pending";
        aadhaarStatusElement.textContent = "Awaiting Aadhaar verification";
        
        isAadhaarVerified = false;
        submitButton.disabled = true;
        aadhaarVerificationRequired.style.display = "block";
    });
    
    // Process Aadhaar OCR
    async function processAadhaarOCR(canvas) {
        try {
            // In a real application, this would use Tesseract.js or a backend OCR service
            // For demo purposes, we'll simulate Aadhaar recognition
            
            // Simulate OCR processing delay
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // Generate a fake but valid-looking Aadhaar number
            // In a real app, this would come from the OCR result
            const fakeAadhaarNum = Array(4).fill(0).map(() => 
                Math.floor(Math.random() * 10000).toString().padStart(4, '0')
            ).join(" ");
            
            aadhaarNumberInput.value = fakeAadhaarNum;
            
            // Update validation step status
            stepValidation.className = "step-icon step-complete";
            stepValidation.textContent = "✓";
            
            // Simulate validation delay
            setTimeout(() => {
                // Update verification step status
                stepVerification.className = "step-icon step-complete";
                stepVerification.textContent = "✓";
                
                // Update verification status
                aadhaarStatusElement.className = "aadhaar-status status-verified";
                aadhaarStatusElement.textContent = "Aadhaar verified successfully";
                
                // Hide processing indicator
                processingIndicator.style.display = "none";
                
                // Set verification as complete
                isAadhaarVerified = true;
                
                // Enable submit button if verification is complete
                submitButton.disabled = false;
                aadhaarVerificationRequired.style.display = "none";
                
            }, 1500);
            
        } catch (error) {
            console.error("Error in Aadhaar OCR:", error);
            
            // Update step status to error
            stepOCR.className = "step-icon step-error";
            stepOCR.textContent = "✗";
            
            // Update verification status
            aadhaarStatusElement.className = "aadhaar-status status-failed";
            aadhaarStatusElement.textContent = "OCR failed. Please try again.";
            
            // Hide processing indicator
            processingIndicator.style.display = "none";
        }
    }
    
    // Start tracking location
    function startLocationTracking() {
        // Update date/time
        updateDateTime();
        
        // Request location permissions
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                savePosition,
                handleLocationError,
                { enableHighAccuracy: true }
            );
            
            // Continuously update location
            locationUpdateInterval = setInterval(() => {
                navigator.geolocation.getCurrentPosition(
                    savePosition,
                    handleLocationError,
                    { enableHighAccuracy: true }
                );
                
                // Update date/time
                updateDateTime();
            }, 5000);
        } else {
            handleLocationError({ code: 0, message: "Geolocation not supported" });
        }
    }
    
    // Update date and time
    function updateDateTime() {
        const now = new Date();
        datetimeElement.textContent = now.toLocaleString();
    }
    
    // Save position data
    function savePosition(position) {
        currentPosition = position;
        const { latitude, longitude } = position.coords;
        
        // Update UI with coordinates
        gpsCoordinatesElement.textContent = `${latitude.toFixed(6)}, ${longitude.toFixed(6)}`;
        
        // Reverse geocode to get address
        reverseGeocode(latitude, longitude);
        
        // Update status UI
        locationStatusElement.innerHTML = `
            <div class="location-status status-success">Location detected successfully</div>
        `;
    }
    
    // Handle location errors
    function handleLocationError(error) {
        console.error("Location error:", error);
        
        let errorMessage = "Unknown error occurred";
        switch(error.code) {
            case 1:
                errorMessage = "Location permission denied";
                break;
            case 2:
                errorMessage = "Position unavailable";
                break;
            case 3:
                errorMessage = "Location request timed out";
                break;
        }
        
        // Update UI with error
        gpsCoordinatesElement.textContent = "Error detecting location";
        gpsAddressElement.textContent = errorMessage;
        
        // Update status UI
        locationStatusElement.innerHTML = `
            <div class="location-status status-error">${errorMessage}</div>
        `;
    }
    
    // Reverse geocode coordinates to address
    function reverseGeocode(lat, lng) {
        // In a real app, this would use a geocoding service like Google Maps API
        // For demo purposes, we'll simulate address resolution
        
        setTimeout(() => {
            // Generate a fake but realistic-looking address
            const addresses = [
                "123 Main Street, Bengaluru, Karnataka 560001",
                "45 Park Avenue, Mumbai, Maharashtra 400001",
                "78 Rajpath Road, New Delhi, Delhi 110001",
                "22 Beach Road, Chennai, Tamil Nadu 600001",
                "56 Salt Lake, Kolkata, West Bengal 700001",
                "90 MG Road, Pune, Maharashtra 411001"
            ];
            
            const randomAddress = addresses[Math.floor(Math.random() * addresses.length)];
            gpsAddressElement.textContent = randomAddress;
        }, 1000);
    }
    
    // Start recording
    startRecordBtn.addEventListener("click", () => {
       if (stream) {
           // Reset emotion data
           emotionData = {
               happy: [],
               neutral: [],
               sad: [],
               angry: []
           };
           
           // Start recording
           mediaRecorder = new MediaRecorder(stream);
           recordedChunks = [];
           
           mediaRecorder.ondataavailable = function(e) {
               if (e.data.size > 0) {
                   recordedChunks.push(e.data);
               }
           };
           
           mediaRecorder.onstop = function() {
               // Process recorded video
               const blob = new Blob(recordedChunks, { type: 'video/webm' });
               const videoURL = URL.createObjectURL(blob);
               
               // In a real app, you would upload the video to a server
               console.log("Video recorded", videoURL);
               
               // Get final sentiment
               const finalSentiment = getFinalSentiment();
               console.log("Final video sentiment:", finalSentiment);
           };
           
           // Start recording
           mediaRecorder.start();
           
           // Update UI
           startRecordBtn.disabled = true;
           stopRecordBtn.disabled = false;
           recordingIndicator.style.display = "inline";
           
           // Start recording timer
           recordingTime = 0;
           recordingTimer.textContent = formatTime(recordingTime);
           timerInterval = setInterval(() => {
               recordingTime++;
               recordingTimer.textContent = formatTime(recordingTime);
           }, 1000);
           
           // Start face detection
           startFaceDetection();
           
       } else {
           alert("Camera access required before recording");
       }
    });
    
    // Stop recording
    stopRecordBtn.addEventListener("click", () => {
        if (mediaRecorder && mediaRecorder.state === "recording") {
            // Stop recording
            mediaRecorder.stop();
            
            // Stop timer
            clearInterval(timerInterval);
            
            // Update UI
            startRecordBtn.disabled = false;
            stopRecordBtn.disabled = true;
            recordingIndicator.style.display = "none";
            
            // Stop face detection
            stopFaceDetection();
        }
    });
    
    // Format time for display
    function formatTime(seconds) {
        const minutes = Math.floor(seconds / 60);
        const remainingSeconds = seconds % 60;
        return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
    }
    
    // Form submission handler
    form.addEventListener("submit", function(event) {
        event.preventDefault();
        
        // Check if Aadhaar is verified
        if (!isAadhaarVerified) {
            alert("Please complete Aadhaar verification before submitting");
            return;
        }
        
        // In a real application, you would submit the form data to a server
        // For demo purposes, we'll just show a confirmation message
        
        // Get form data
        const formData = {
            userRole: document.getElementById("userRole").value,
            ownerName: document.getElementById("ownerName").value,
            landLocation: document.getElementById("landLocation").value,
            landSize: document.getElementById("landSize").value,
            feedback: document.getElementById("feedback").value,
            aadhaarNumber: aadhaarNumberInput.value,
            gpsCoordinates: gpsCoordinatesElement.textContent,
            gpsAddress: gpsAddressElement.textContent,
            timestamp: datetimeElement.textContent,
            videoSentiment: getFinalSentiment(),
            // In a real app, you would include the video and signature as well
        };
        
        console.log("Form submitted:", formData);
        
        // Show confirmation message
        message.classList.remove("hidden");
        form.reset();
        clearCanvas();
        
        // Reset Aadhaar verification
        resetAadhaarBtn.click();
    });
    
    // Scroll to form when Get Started is clicked
    getStartedBtn.addEventListener("click", function(event) {
        event.preventDefault();
        const registrationForm = document.getElementById("registrationForm");
        registrationForm.scrollIntoView({ behavior: "smooth" });
    });
    
    // Initialize everything on page load
    window.addEventListener("load", function() {
        // Init video capture with face detection
        initVideoCapture();
        
        // Init Aadhaar capture
        initAadhaarCapture();
    });
    
    // Text Sentiment Analysis (simulated for demo)
    const feedbackInput = document.getElementById("feedback");
    feedbackInput.addEventListener("blur", function() {
        const text = feedbackInput.value.trim();
        if (text) {
            // In a real app, this would call a sentiment analysis API
            // For demo purposes, we'll use a simple word-based approach
            
            const positiveWords = ["good", "great", "excellent", "happy", "satisfied", "best", "fantastic", "superb"];
            const negativeWords = ["bad", "poor", "terrible", "worst", "waste", "disappointed", "horrible", "awful"];
            
            let positiveCount = 0;
            let negativeCount = 0;
            
            const words = text.toLowerCase().split(/\s+/);
            
            words.forEach(word => {
                if (positiveWords.includes(word)) {
                    positiveCount++;
                } else if (negativeWords.includes(word)) {
                    negativeCount++;
                }
            });
            
            let sentiment = "Neutral";
            if (positiveCount > negativeCount) {
                sentiment = "Positive";
            } else if (negativeCount > positiveCount) {
                sentiment = "Negative";
            }
            
            console.log("Text sentiment:", sentiment);
        }
    });
    
    // Clean up resources on page unload
    window.addEventListener("beforeunload", function() {
        // Stop location tracking
        if (locationUpdateInterval) {
            clearInterval(locationUpdateInterval);
        }
        
        // Stop face detection
        stopFaceDetection();
        
        // Stop video recording if active
        if (mediaRecorder && mediaRecorder.state === "recording") {
            mediaRecorder.stop();
        }
        
        // Release camera streams
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
        }
        
        if (aadhaarStream) {
            aadhaarStream.getTracks().forEach(track => track.stop());
        }
    });
</script>
</body>
</html>
